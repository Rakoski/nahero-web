<div class="practice-exam-container">
  <div *ngIf="isLoading" class="loading-container">
    <div class="flex flex-col items-center justify-center gap-2">
      <div
        class="h-8 w-8 animate-spin rounded-full border-3 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
        role="status"
      >
        <span
          class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]"
          >Loading...</span
        >
      </div>
      <div class="text-sm mt-2">{{ loadingMessage }}</div>
    </div>
  </div>

  <div *ngIf="error && !isLoading" class="error-container">
    <div>
      <p>{{ error }}</p>
      <button ubButton (click)="router.navigate(['/practice-exams'])" style="margin-top: 10px">
        Voltar para Simulados
      </button>
    </div>
  </div>

  <div *ngIf="!isLoading && !error && questions.length > 0" class="exam-content">
    <div class="question-nav">
      <div class="exam-timer" [ngClass]="{ warning: timeRemaining < 300 }">
        <span class="mr-2">Tempo restante:</span>
        <span class="timer-value">{{ formatTime(timeRemaining) }}</span>
      </div>

      <div class="nav-controls">
        <button
          class="nav-arrow"
          (click)="previousQuestionPage()"
          [disabled]="questionPageIndex === 0"
        >
          &lt;
        </button>
        <div class="question-list">
          <button
            *ngFor="let question of getVisibleQuestions(); let i = index"
            class="question-nav-item"
            [ngClass]="{
              current: questionPageIndex * questionsPerPage + i === currentQuestionIndex,
              answered: hasAnswered(question.id)
            }"
            (click)="goToQuestion(questionPageIndex * questionsPerPage + i)"
          >
            {{ questionPageIndex * questionsPerPage + i + 1 }}
          </button>
        </div>
        <button
          class="nav-arrow"
          (click)="nextQuestionPage()"
          [disabled]="(questionPageIndex + 1) * questionsPerPage >= questions.length"
        >
          &gt;
        </button>
      </div>

      <div class="question-counter">
        <span>{{ currentQuestionIndex + 1 }} de {{ questions.length }}</span>
      </div>
    </div>

    <main class="exam-main">
      <div class="question-content">
        <div class="question-card">
          <div class="question-text">
            <h2 class="mb-2">Questão {{ currentQuestionIndex + 1 }}</h2>
            <div [innerHTML]="getCurrentQuestion()?.content"></div>

            <div *ngIf="getCurrentQuestion()?.imageUrl" class="question-image">
              <img [src]="getCurrentQuestion()?.imageUrl" alt="Question Image" />
            </div>
          </div>
        </div>

        <div class="alternatives-container">
          <div class="alternatives-type">
            <p
              *ngIf="getCurrentQuestion() && isMultipleChoice(getCurrentQuestion()!)"
              class="choice-type"
            >
              <strong>Questão de múltipla escolha:</strong> Selecione todas as alternativas
              corretas.
            </p>
            <p
              *ngIf="getCurrentQuestion() && isObjective(getCurrentQuestion()!)"
              class="choice-type"
            >
              <strong>Questão objetiva:</strong> Selecione apenas uma alternativa.
            </p>
          </div>

          <div
            *ngIf="!questionAlternatives.has(getCurrentQuestion()?.id || '')"
            class="loading-alternatives"
          >
            <div class="flex flex-col items-center justify-center gap-2 py-6">
              <div
                class="h-6 w-6 animate-spin rounded-full border-2 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
                role="status"
              >
                <span
                  class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]"
                  >Loading...</span
                >
              </div>
              <div class="text-sm mt-2">Carregando alternativas...</div>
            </div>
          </div>

          <div
            *ngIf="questionAlternatives.has(getCurrentQuestion()?.id || '')"
            class="alternatives-list"
          >
            <div
              *ngFor="let alternative of getAlternativesForCurrentQuestion()"
              class="alternative-item"
              [ngClass]="{ selected: isSelected(getCurrentQuestion()?.id || '', alternative.id) }"
              (click)="toggleAnswer(getCurrentQuestion()?.id || '', alternative.id)"
            >
              <div class="alternative-marker">
                <div class="marker-indicator"></div>
              </div>
              <div class="alternative-text" [innerHTML]="alternative.content"></div>
            </div>
          </div>
        </div>

        <div class="question-actions">
          <button
            ubButton
            variant="outline"
            [disabled]="currentQuestionIndex === 0"
            (click)="previousQuestion()"
          >
            Anterior
          </button>

          <button
            ubButton
            variant="outline"
            *ngIf="currentQuestionIndex < questions.length - 1"
            (click)="nextQuestion()"
          >
            Próxima
          </button>

          <button
            ubButton
            *ngIf="currentQuestionIndex === questions.length - 1"
            (click)="submitExam()"
          >
            Finalizar Simulado
          </button>
        </div>
      </div>
    </main>
  </div>

  <div *ngIf="!isLoading && !error && questions.length === 0" class="empty-state">
    <h2>Nenhuma questão disponível</h2>
    <p>Este simulado não possui questões cadastradas.</p>
    <button ubButton (click)="router.navigate(['/practice-exams'])">Voltar para Simulados</button>
  </div>
</div>
